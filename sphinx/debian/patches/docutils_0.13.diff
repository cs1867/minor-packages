From c2bcd19943e2639518693f6516a2ff2976cec3ef Mon Sep 17 00:00:00 2001
From: Takeshi KOMIYA <i.tkomiya@gmail.com>
Date: Sat, 10 Dec 2016 20:29:34 +0900
Subject: Fix HTML builders crashes with docutils 0.13

Origin: upstream, https://github.com/sphinx-doc/sphinx/pull/3217
Bug: https://github.com/sphinx-doc/sphinx/issues/3212
Patch-Name: docutils_0.13.diff
---
 sphinx/writers/html.py | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/sphinx/writers/html.py b/sphinx/writers/html.py
index 6a30d4c..1d26429 100644
--- a/sphinx/writers/html.py
+++ b/sphinx/writers/html.py
@@ -16,6 +16,7 @@ import copy
 import warnings
 
 from six import string_types
+import docutils
 from docutils import nodes
 from docutils.writers.html4css1 import Writer, HTMLTranslator as BaseTranslator
 
@@ -498,6 +499,16 @@ class HTMLTranslator(BaseTranslator):
                         node['height'] = str(size[1])
         BaseTranslator.visit_image(self, node)
 
+    # overwritten
+    def depart_image(self, node):
+        if docutils.__version__ >= "0.13":
+            # since docutils-0.13, HTMLWriter does not push context data on visit_image()
+            if node['uri'].lower().endswith(('svg', 'svgz')):
+                self.body.append(self.context.pop())
+        else:
+            # docutils-0.12 or below, HTML Writer always push context data on visit_image()
+            self.body.append(self.context.pop())
+
     def visit_toctree(self, node):
         # this only happens when formatting a toc from env.tocs -- in this
         # case we don't want to include the subtree
